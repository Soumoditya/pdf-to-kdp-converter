<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PDF → KDP (6×9) Converter – Free, Client‑Side</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{font-family:Arial,sans-serif;max-width:900px;margin:2rem auto;padding:1rem;text-align:center;background:#fafafa;}
  h1{font-size:1.8rem;margin-bottom:.5rem;}
  p{font-size:1rem;color:#333;}
  #dropZone{border:3px dashed #4caf50;padding:2rem;margin:1rem 0;border-radius:8px;background:#f8fff8;}
  #dropZone.dragover{background:#e8f8e8;}
  #progress{display:none;width:100%;height:24px;background:#ddd;border-radius:4px;overflow:hidden;margin:1rem 0;}
  #bar{height:100%;width:0;background:#4caf50;transition:width .3s;}
  #result{display:none;margin-top:1rem;}
  a.button{display:inline-block;background:#0066cc;color:#fff;padding:.6rem 1.2rem;border-radius:4px;text-decoration:none;margin-top:.5rem;}
</style>
</head>
<body>

<h1>PDF → KDP (6 × 9 in) Converter</h1>
<p>Upload any PDF (≥ 100 pages). The tool creates a print‑ready KDP file with proper margins, page numbers and bleed.</p>

<div id="dropZone">
  <p>Drop PDF here or <label><u>click to select</u><input type="file" id="pdfFile" accept=".pdf" style="display:none;"></label></p>
</div>

<div id="progress"><div id="bar"></div></div>
<div id="result"></div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js';
</script>

<script>
/* ---------- CONFIG ---------- */
const TRIM_W = 6;   // inches
const TRIM_H = 9;   // inches
const MARGIN = 0.75; // inches (all sides)
const DPI = 300;    // output resolution
const MIN_PAGES = 100;

/* ---------- HELPERS ---------- */
const inch = v => v * DPI;
const px = v => v + 'px';

function setProgress(pct){ document.getElementById('bar').style.width = pct + '%'; }
function showResult(html){ document.getElementById('result').innerHTML = html; document.getElementById('result').style.display='block'; }

/* ---------- MAIN ---------- */
document.getElementById('pdfFile').addEventListener('change', handleFile);
document.getElementById('dropZone').addEventListener('dragover', e=>{e.preventDefault(); e.target.classList.add('dragover');});
document.getElementById('dropZone').addEventListener('dragleave', e=>{e.target.classList.remove('dragover');});
document.getElementById('dropZone').addEventListener('drop', e=>{
  e.preventDefault(); e.target.classList.remove('dragover');
  const f = e.dataTransfer.files[0];
  if(f && f.type==='application/pdf') handleFile({target:{files:[f]}});
});

async function handleFile(e){
  const file = e.target.files[0];
  if(!file) return;
  document.getElementById('progress').style.display='block';
  setProgress(0);
  document.getElementById('result').style.display='none';

  try{
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:arrayBuffer}).promise;
    const numPages = pdf.numPages;
    if(numPages < MIN_PAGES) throw new Error(`PDF has only ${numPages} pages – KDP needs ≥ ${MIN_PAGES}.`);

    // jsPDF (inches)
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF({orientation:'p', unit:'in', format:[TRIM_W, TRIM_H], compress:true});
    doc.setFont('times');
    doc.setFontSize(12);

    const contentWidth  = TRIM_W - 2*MARGIN;
    const contentHeight = TRIM_H - 2*MARGIN;

    // Canvas for rendering each page
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    for(let i=1;i<=numPages;i++){
      const page = await pdf.getPage(i);
      const vp = page.getViewport({scale:1});
      const scale = Math.min(contentWidth*DPI/vp.width, contentHeight*DPI/vp.height);
      const viewport = page.getViewport({scale});

      canvas.width  = viewport.width;
      canvas.height = viewport.height;

      await page.render({canvasContext:ctx, viewport}).promise;

      // Add page image
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      doc.addImage(imgData, 'JPEG', MARGIN, MARGIN, contentWidth, contentHeight);

      // Page number (footer)
      const pageNum = i.toString();
      doc.setFontSize(10);
      doc.text(pageNum, TRIM_W/2, TRIM_H - MARGIN/2, {align:'center'});
      doc.setFontSize(12);

      if(i < numPages) doc.addPage();
      setProgress((i/numPages)*100);
    }

    const blob = doc.output('blob');
    const url = URL.createObjectURL(blob);
    showResult(`
      <p>Success! ${numPages} pages → KDP‑ready PDF</p>
      <a href="${url}" download="KDP_${file.name.replace('.pdf','')}.pdf" class="button">Download PDF</a>
    `);
  }catch(err){
    showResult(`<p style="color:red;">Error: ${err.message}</p>`);
  }finally{
    document.getElementById('progress').style.display='none';
  }
}
</script>
</body>
</html>
